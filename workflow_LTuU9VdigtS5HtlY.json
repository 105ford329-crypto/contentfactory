{"updatedAt":"2025-12-26T11:15:53.937Z","createdAt":"2025-12-24T15:59:08.227Z","id":"LTuU9VdigtS5HtlY","name":"Workflow 10 - Analytics & Performance Tracker","description":null,"active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"cronExpression","expression":"0 */6 * * *"}]}},"id":"schedule-trigger","name":"Schedule Every 6h","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[240,400]},{"parameters":{"httpMethod":"POST","path":"analyze-performance","options":{}},"id":"webhook-trigger","name":"Webhook Trigger","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[240,550],"webhookId":"analyze-performance"},{"parameters":{"operation":"getAll","sheetId":"={{ $env.GOOGLE_SHEET_ID }}","range":"Published_Content!A:Z","options":{}},"id":"get-published-content","name":"Get Published Content","type":"n8n-nodes-base.googleSheets","typeVersion":4,"position":[460,475]},{"parameters":{"jsCode":"// Get content that needs metrics update (published > 1 hour ago)\nconst now = new Date();\nconst published = $input.all().map(item => item.json);\n\nconst needsUpdate = published.filter(item => {\n  const publishedAt = new Date(item.published_at);\n  const hoursSince = (now - publishedAt) / (1000 * 60 * 60);\n  \n  // Update if:\n  // - Published 1+ hours ago and no initial metrics\n  // - Published 1+ days ago and no daily metrics\n  // - Published 7+ days ago and no weekly metrics\n  \n  const hasInitial = item.metrics_1h;\n  const hasDaily = item.metrics_24h;\n  const hasWeekly = item.metrics_7d;\n  \n  if (hoursSince >= 1 && !hasInitial) return true;\n  if (hoursSince >= 24 && !hasDaily) return true;\n  if (hoursSince >= 168 && !hasWeekly) return true;\n  \n  return false;\n});\n\nreturn needsUpdate.map(item => ({json: item}));"},"id":"filter-needs-update","name":"Filter Needs Metrics Update","type":"n8n-nodes-base.code","typeVersion":2,"position":[680,475]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.platform }}","operation":"equals","value2":"threads"}]}},"id":"route-platform","name":"Route by Platform","type":"n8n-nodes-base.switch","typeVersion":3,"position":[900,475]},{"parameters":{"url":"https://graph.threads.net/v1.0/{{ $json.post_id }}","sendQuery":true,"queryParameters":{"parameters":[{"name":"fields","value":"id,text,media_type,media_url,permalink,timestamp,is_quote_post,like_count,reply_count,repost_count,quote_count,views"},{"name":"access_token","value":"={{ $env.THREADS_ACCESS_TOKEN }}"}]},"options":{}},"id":"get-threads-metrics","name":"Get Threads Metrics","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1120,400]},{"parameters":{"url":"https://www.tiktok.com/oembed","sendQuery":true,"queryParameters":{"parameters":[{"name":"url","value":"={{ $json.post_url }}"}]},"options":{}},"id":"get-tiktok-metrics","name":"Get TikTok Metrics (oembed)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1120,550]},{"parameters":{"jsCode":"const content = $input.first().json;\nconst metrics = $input.all()[1]?.json || {};\n\nconst now = new Date();\nconst publishedAt = new Date(content.published_at);\nconst hoursSince = (now - publishedAt) / (1000 * 60 * 60);\n\nlet metricsField;\nif (hoursSince < 24) {\n  metricsField = 'metrics_1h';\n} else if (hoursSince < 168) {\n  metricsField = 'metrics_24h';\n} else {\n  metricsField = 'metrics_7d';\n}\n\n// Platform-specific metrics extraction\nlet extractedMetrics = {};\n\nif (content.platform === 'threads') {\n  extractedMetrics = {\n    views: metrics.views || 0,\n    likes: metrics.like_count || 0,\n    comments: metrics.reply_count || 0,\n    shares: metrics.repost_count + metrics.quote_count || 0\n  };\n} else if (content.platform === 'tiktok') {\n  // TikTok oembed provides limited data, need ScraperCreators for full metrics\n  extractedMetrics = {\n    views: 0, // need API call\n    likes: 0,\n    comments: 0,\n    shares: 0\n  };\n}\n\n// Calculate engagement rate\nconst totalEngagement = extractedMetrics.likes + extractedMetrics.comments + extractedMetrics.shares;\nconst er = extractedMetrics.views > 0 ? (totalEngagement / extractedMetrics.views * 100).toFixed(2) : 0;\n\nreturn {\n  row_id: content.row_id,\n  [metricsField]: JSON.stringify({\n    ...extractedMetrics,\n    er: parseFloat(er),\n    checked_at: now.toISOString()\n  }),\n  last_checked: now.toISOString()\n};"},"id":"calculate-metrics","name":"Calculate Metrics & ER","type":"n8n-nodes-base.code","typeVersion":2,"position":[1340,475]},{"parameters":{"operation":"update","sheetId":"={{ $env.GOOGLE_SHEET_ID }}","range":"Published_Content","options":{"valueInputMode":"USER_ENTERED"},"columns":{"mappings":[{"fromColumn":"row_id","toColumn":"row_id"},{"fromColumn":"metrics_1h","toColumn":"metrics_1h"},{"fromColumn":"metrics_24h","toColumn":"metrics_24h"},{"fromColumn":"metrics_7d","toColumn":"metrics_7d"},{"fromColumn":"last_checked","toColumn":"last_checked"}]}},"id":"update-metrics","name":"Update Google Sheets","type":"n8n-nodes-base.googleSheets","typeVersion":4,"position":[1560,475]},{"parameters":{"operation":"getAll","sheetId":"={{ $env.GOOGLE_SHEET_ID }}","range":"Published_Content!A:Z","options":{}},"id":"get-analytics-data","name":"Get Analytics Data","type":"n8n-nodes-base.googleSheets","typeVersion":4,"position":[240,750]},{"parameters":{"jsCode":"const allContent = $input.all().map(item => item.json);\nconst period = $json.body?.period || 'week';\n\nconst now = new Date();\nlet startDate = new Date();\nif (period === 'week') {\n  startDate.setDate(now.getDate() - 7);\n} else if (period === 'month') {\n  startDate.setMonth(now.getMonth() - 1);\n}\n\n// Filter by period\nconst periodContent = allContent.filter(item => {\n  const date = new Date(item.published_at);\n  return date >= startDate && date <= now;\n});\n\n// Analyze by platform\nconst byPlatform = {};\nperiodContent.forEach(item => {\n  const platform = item.platform;\n  if (!byPlatform[platform]) {\n    byPlatform[platform] = {\n      count: 0,\n      total_views: 0,\n      total_likes: 0,\n      total_er: 0,\n      items: []\n    };\n  }\n  \n  // Get latest metrics\n  const metrics = JSON.parse(item.metrics_7d || item.metrics_24h || item.metrics_1h || '{}');\n  \n  byPlatform[platform].count += 1;\n  byPlatform[platform].total_views += metrics.views || 0;\n  byPlatform[platform].total_likes += metrics.likes || 0;\n  byPlatform[platform].total_er += parseFloat(metrics.er || 0);\n  byPlatform[platform].items.push({\n    title: item.title,\n    metrics: metrics,\n    published_at: item.published_at\n  });\n});\n\n// Calculate averages and find top performers\nconst analytics = {};\nfor (const [platform, data] of Object.entries(byPlatform)) {\n  const avgViews = data.total_views / data.count;\n  const avgLikes = data.total_likes / data.count;\n  const avgER = data.total_er / data.count;\n  \n  // Sort by ER to find top performers\n  const topPerformers = data.items\n    .sort((a, b) => (b.metrics.er || 0) - (a.metrics.er || 0))\n    .slice(0, 3);\n  \n  analytics[platform] = {\n    count: data.count,\n    avg_views: avgViews.toFixed(0),\n    avg_likes: avgLikes.toFixed(0),\n    avg_er: avgER.toFixed(2),\n    top_performers: topPerformers\n  };\n}\n\n// Format message\nconst periodLabel = period === 'week' ? '–∑–∞ –Ω–µ–¥–µ–ª—é' : '–∑–∞ –º–µ—Å—è—Ü';\nlet message = `üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π ${periodLabel}\\n\\n`;\n\nfor (const [platform, stats] of Object.entries(analytics)) {\n  const emoji = {\n    'threads': 'üßµ',\n    'tiktok': 'üéµ',\n    'instagram': 'üì∏'\n  }[platform] || 'üìÑ';\n  \n  message += `${emoji} ${platform.toUpperCase()}\\n`;\n  message += `–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: ${stats.count}\\n`;\n  message += `–°—Ä. –ø—Ä–æ—Å–º–æ—Ç—Ä—ã: ${stats.avg_views}\\n`;\n  message += `–°—Ä. –ª–∞–π–∫–∏: ${stats.avg_likes}\\n`;\n  message += `–°—Ä. ER: ${stats.avg_er}%\\n\\n`;\n  \n  message += `üî• –¢–æ–ø-3 –ø–æ ER:\\n`;\n  stats.top_performers.forEach((item, i) => {\n    message += `${i+1}. ${item.title} (ER: ${item.metrics.er}%)\\n`;\n  });\n  message += '\\n';\n}\n\n// Overall stats\nconst totalPublished = periodContent.length;\nconst totalViews = Object.values(byPlatform).reduce((sum, p) => sum + p.total_views, 0);\nconst avgERAll = Object.values(analytics).reduce((sum, p) => sum + parseFloat(p.avg_er), 0) / Object.keys(analytics).length;\n\nmessage += `\\nüìà –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\\n`;\nmessage += `–í—Å–µ–≥–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: ${totalPublished}\\n`;\nmessage += `–í—Å–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: ${totalViews}\\n`;\nmessage += `–°—Ä–µ–¥–Ω–∏–π ER: ${avgERAll.toFixed(2)}%\\n`;\n\n// Best platform\nconst bestPlatform = Object.entries(analytics).sort((a, b) => \n  parseFloat(b[1].avg_er) - parseFloat(a[1].avg_er)\n)[0];\n\nif (bestPlatform) {\n  message += `\\nÔøΩÔøΩÔøΩÔøΩ –õ—É—á—à–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞: ${bestPlatform[0]} (ER: ${bestPlatform[1].avg_er}%)`;\n}\n\nreturn {\n  message,\n  chatId: $json.body?.chatId || process.env.TELEGRAM_CHAT_ID,\n  analytics,\n  period\n};"},"id":"analyze-performance","name":"Analyze Performance","type":"n8n-nodes-base.code","typeVersion":2,"position":[460,750]},{"parameters":{"chatId":"={{ $json.chatId }}","text":"={{ $json.message }}"},"id":"send-telegram","name":"Send to Telegram","type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[680,750]}],"connections":{"Schedule Every 6h":{"main":[[{"node":"Get Published Content","type":"main","index":0}]]},"Webhook Trigger":{"main":[[{"node":"Get Published Content","type":"main","index":0},{"node":"Get Analytics Data","type":"main","index":0}]]},"Get Published Content":{"main":[[{"node":"Filter Needs Metrics Update","type":"main","index":0}]]},"Filter Needs Metrics Update":{"main":[[{"node":"Route by Platform","type":"main","index":0}]]},"Route by Platform":{"main":[[{"node":"Get Threads Metrics","type":"main","index":0}],[{"node":"Get TikTok Metrics (oembed)","type":"main","index":0}]]},"Get Threads Metrics":{"main":[[{"node":"Calculate Metrics & ER","type":"main","index":0},{"node":"Calculate Metrics & ER","type":"main","index":1}]]},"Get TikTok Metrics (oembed)":{"main":[[{"node":"Calculate Metrics & ER","type":"main","index":0},{"node":"Calculate Metrics & ER","type":"main","index":1}]]},"Calculate Metrics & ER":{"main":[[{"node":"Update Google Sheets","type":"main","index":0}]]},"Get Analytics Data":{"main":[[{"node":"Analyze Performance","type":"main","index":0}]]},"Analyze Performance":{"main":[[{"node":"Send to Telegram","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":null,"versionId":"e8faabf7-e4a2-4e0b-a49a-5986ac856622","versionCounter":3,"triggerCount":0,"shared":[{"updatedAt":"2025-12-24T15:59:08.227Z","createdAt":"2025-12-24T15:59:08.227Z","role":"workflow:owner","workflowId":"LTuU9VdigtS5HtlY","projectId":"RBPPu9AATeVK4CWS","project":{"updatedAt":"2025-09-12T08:23:30.032Z","createdAt":"2025-04-06T11:26:22.366Z","id":"RBPPu9AATeVK4CWS","name":"Ruslan 111 <105ford329@gmail.com>","type":"personal","icon":null,"description":null,"projectRelations":[{"updatedAt":"2025-04-06T11:26:22.366Z","createdAt":"2025-04-06T11:26:22.366Z","userId":"857820b0-f530-430a-b69c-96a0ec14e554","projectId":"RBPPu9AATeVK4CWS","user":{"updatedAt":"2026-01-15T07:57:19.897Z","createdAt":"2025-04-06T11:26:21.157Z","id":"857820b0-f530-430a-b69c-96a0ec14e554","email":"105ford329@gmail.com","firstName":"Ruslan","lastName":"111","personalizationAnswers":null,"settings":{"userActivated":true,"easyAIWorkflowOnboarded":true,"firstSuccessfulWorkflowId":"28ntO5KaE2bWGofZ","userActivatedAt":1746260344700,"npsSurvey":{"responded":true,"lastShownAt":1762343016289},"dismissedCallouts":{"preBuiltAgentsCalloutTelegram":true}},"disabled":false,"mfaEnabled":false,"lastActiveAt":"2026-01-14","isPending":false}}]}}],"tags":[]}