{"updatedAt":"2025-12-26T11:15:00.594Z","createdAt":"2025-12-24T14:20:47.429Z","id":"CgQnHIkKYfsNicA4","name":"Workflow 5 - Carousel Generator (Ideogram AI)","description":null,"active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"generate-carousel","options":{}},"name":"Webhook Trigger","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-2208,112],"webhookId":"generate-carousel","id":"4ef01300-c703-4146-bd69-eeb5a9d133ce"},{"parameters":{"documentId":{"__rl":true,"value":"={{ $env.GOOGLE_SHEET_ID }}","mode":"id"},"sheetName":{"__rl":true,"value":"Carousel_Queue","mode":"name"},"options":{}},"name":"Get Carousel Queue","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[-1984,112],"id":"b764039b-7ad7-4819-b682-1ca2ebeee918"},{"parameters":{"jsCode":"// Filter carousels ready for generation\nconst items = $input.all();\nconst webhookData = $('Webhook Trigger').first()?.json?.body;\n\n// If triggered by webhook with specific content_id\nif (webhookData?.content_id) {\n  const item = items.find(i => i.json.content_id === webhookData.content_id);\n  if (item) {\n    return [{ json: { ...item.json, chat_id: webhookData.chat_id } }];\n  }\n  return [];\n}\n\n// Otherwise, get items with status = pending\nreturn items\n  .filter(i => i.json.status === 'pending')\n  .slice(0, 3)\n  .map(i => ({ json: i.json }));"},"name":"Filter Pending Carousels","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1760,112],"id":"77b35f9b-da7a-486a-beeb-72773ca7d814"},{"parameters":{"documentId":{"__rl":true,"value":"={{ $env.GOOGLE_SHEET_ID }}","mode":"id"},"sheetName":{"__rl":true,"value":"Content_Queue","mode":"name"},"options":{}},"name":"Get Content Data","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[-1536,112],"id":"e1a4b6a7-86fa-4e9b-ab18-839c2a171101"},{"parameters":{"method":"POST","url":"https://openrouter.ai/api/v1/chat/completions","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"model\": \"anthropic/claude-3.5-sonnet\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Ты — копирайтер для Instagram каруселей. Создай контент для {{ $json.slides_count || 7 }} слайдов карусели.\\n\\nФорм��т ответа — JSON массив объектов:\\n[\\n  { \\\"slide_num\\\": 1, \\\"headline\\\": \\\"Заголовок слайда\\\", \\\"body\\\": \\\"Короткий текст (2-3 строки)\\\" },\\n  ...\\n]\\n\\nПервый слайд — хук (цепляющий заголовок). Последний — CTA. Слайды посередине — основной контент с ценностью.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"Тема карусели: {{ $json.hook || $json.topic }}\\n\\nОписание: {{ $json.body }}\\n\\nСоздай {{ $json.slides_count || 7 }} слайдов.\"\n    }\n  ],\n  \"max_tokens\": 1500\n}","options":{}},"name":"Generate Slides Content (Claude)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1328,112],"id":"90f781f8-de0d-4212-98dd-a4c5fdcbf692"},{"parameters":{"jsCode":"// Parse Claude response and prepare slides data\nconst response = $input.first().json;\nconst carousel = $('Filter Pending Carousels').first().json;\nconst content = $('Get Content Data').first().json;\n\n// Extract JSON from Claude response\nconst text = response.choices[0].message.content;\nlet slides = [];\n\ntry {\n  // Try to parse JSON directly\n  const jsonMatch = text.match(/\\[\\s*\\{[\\s\\S]*\\}\\s*\\]/);\n  if (jsonMatch) {\n    slides = JSON.parse(jsonMatch[0]);\n  }\n} catch (e) {\n  // Fallback: create default slides\n  slides = [\n    { slide_num: 1, headline: content.hook || 'Заголовок', body: '' },\n    { slide_num: 2, headline: 'Пункт 1', body: content.body?.slice(0, 100) || '' },\n    { slide_num: 3, headline: 'Пункт 2', body: '' },\n    { slide_num: 4, headline: '��ункт 3', body: '' },\n    { slide_num: 5, headline: content.cta || 'Подписывайся!', body: '' }\n  ];\n}\n\nconst style = carousel.ideogram_style || content.cover_style || 'gradient';\nconst totalSlides = slides.length;\n\n// Return each slide as separate item for loop\nreturn slides.map((slide, index) => ({\n  json: {\n    carousel_id: carousel.id,\n    content_id: carousel.content_id,\n    chat_id: carousel.chat_id || $env.TELEGRAM_CHAT_ID,\n    slide_num: index + 1,\n    total_slides: totalSlides,\n    headline: slide.headline,\n    body: slide.body,\n    style,\n    slides_json: JSON.stringify(slides)\n  }\n}));"},"name":"Parse Slides Content","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1104,112],"id":"4dddbfe7-bed2-4889-b37b-9350c2f35fa2"},{"parameters":{"method":"POST","url":"https://api.ideogram.ai/generate","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"image_request\": {\n    \"prompt\": \"Instagram carousel slide {{ $json.slide_num }} of {{ $json.total_slides }}, {{ $json.slide_num === 1 ? 'eye-catching hook slide' : $json.slide_num === $json.total_slides ? 'call-to-action final slide' : 'informative content slide' }}, headline text '{{ $json.headline }}' prominently displayed, {{ $json.body ? 'subtitle: ' + $json.body.slice(0, 50) : '' }}, {{ $json.style === 'bold' ? 'bold dramatic design, high contrast, dark purple background' : $json.style === 'minimal' ? 'minimalist clean design, white background, elegant typography' : $json.style === 'gradient' ? 'smooth gradient background purple to blue, modern look' : 'neon glow effects, cyberpunk style, dark background with glowing text' }}, 1080x1350 Instagram portrait format, clean professional typography, readable text, no watermark, modern social media design\",\n    \"aspect_ratio\": \"ASPECT_4_5\",\n    \"model\": \"V_2\",\n    \"magic_prompt_option\": \"AUTO\"\n  }\n}","options":{}},"name":"Generate Slide (Ideogram)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-880,112],"id":"99d8afca-75a2-4fdc-9d92-f82bfa59d558"},{"parameters":{"jsCode":"// Extract slide URL from Ideogram response\nconst ideogramResponse = $input.first().json;\nconst prevData = $('Parse Slides Content').item.json;\n\nreturn {\n  ...prevData,\n  slide_url: ideogramResponse.data?.[0]?.url || ''\n};"},"name":"Parse Slide URL","type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,112],"id":"dac1159a-0f50-494b-bff2-55b372e97a4b"},{"parameters":{"aggregate":"aggregateAllItemData","destinationFieldName":"slides","options":{}},"name":"Aggregate All Slides","type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-448,112],"id":"96c46ffe-624b-4b75-a0fd-a44f3de1893f"},{"parameters":{"jsCode":"// Combine all slides and prepare final data\nconst slides = $input.first().json.slides;\nconst firstSlide = slides[0];\n\nconst carouselUrls = slides\n  .sort((a, b) => a.slide_num - b.slide_num)\n  .map(s => s.slide_url)\n  .filter(url => url);\n\n// Calculate costs\nconst slidesCount = carouselUrls.length;\nconst costs = {\n  cost_ai: 0.03, // Claude for content\n  cost_images: slidesCount * 0.02, // Ideogram per slide\n  cost_total: 0.03 + (slidesCount * 0.02)\n};\n\nreturn {\n  carousel_id: firstSlide.carousel_id,\n  content_id: firstSlide.content_id,\n  chat_id: firstSlide.chat_id,\n  carousel_urls: carouselUrls,\n  carousel_urls_json: JSON.stringify(carouselUrls),\n  slides_count: slidesCount,\n  cover_url: carouselUrls[0], // First slide as cover\n  ...costs\n};"},"name":"Prepare Final Data","type":"n8n-nodes-base.code","typeVersion":2,"position":[-224,112],"id":"dc7ffa62-f5eb-46a4-b0cb-21d57d5bc1c2"},{"parameters":{"operation":"update","documentId":{"__rl":true,"value":"={{ $env.GOOGLE_SHEET_ID }}","mode":"id"},"sheetName":{"__rl":true,"value":"Carousel_Queue","mode":"name"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $json.carousel_id }}","status":"completed","generated_urls":"={{ $json.carousel_urls_json }}","cover_url":"={{ $json.cover_url }}","slides_count":"={{ $json.slides_count }}"}},"options":{}},"name":"Update Carousel_Queue","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[0,0],"id":"15f7c64f-1538-4d1a-aee3-712bb4be87fa"},{"parameters":{"operation":"update","documentId":{"__rl":true,"value":"={{ $env.GOOGLE_SHEET_ID }}","mode":"id"},"sheetName":{"__rl":true,"value":"Content_Queue","mode":"name"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $json.content_id }}","status":"rendered","carousel_urls":"={{ $json.carousel_urls_json }}","cover_url":"={{ $json.cover_url }}","cost_ai":"={{ $json.cost_ai }}","cost_images":"={{ $json.cost_images }}","cost_total":"={{ $json.cost_total }}"}},"options":{}},"name":"Update Content_Queue","type":"n8n-nodes-base.googleSheets","typeVersion":4.4,"position":[0,208],"id":"cc5e4e43-bf43-44b1-8461-bfe69de55c63"},{"parameters":{"method":"POST","url":"={{ $env.N8N_WEBHOOK_URL }}/webhook/send-preview","sendBody":true,"bodyParameters":{"parameters":[{"name":"content_id","value":"={{ $json.content_id }}"},{"name":"chat_id","value":"={{ $json.chat_id }}"}]},"options":{}},"name":"Trigger Preview (Orchestrator)","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[224,112],"id":"8bb8dd80-2a9b-4f01-bd87-82aca7aa8d33"},{"parameters":{"jsCode":"// Claude analysis + Ideogram images (6-8 slides)\nconst claudeCost = 0.10; // estimated per carousel\nconst slideCount = $input.all().length || 7;\nconst ideogramCost = slideCount * 0.08;\nconst totalCost = claudeCost + ideogramCost;\n\nreturn {\n    timestamp: new Date().toISOString(),\n    service: 'multiple',\n    operation: 'carousel_generation',\n    cost: totalCost,\n    details: JSON.stringify({\n        claude: claudeCost,\n        ideogram: ideogramCost,\n        slides: slideCount\n    })\n};"},"name":"Calculate API Costs","type":"n8n-nodes-base.code","typeVersion":2,"position":[1200,300],"id":"a438e345-5ad8-4cbd-8e0f-ffc04551c1fe"},{"parameters":{"operation":"appendOrUpdate","sheetId":"={{ $env.GOOGLE_SHEET_ID }}","range":"API_Costs","options":{"cellFormat":"USER_ENTERED","useAppend":true},"columns":{"mappings":[{"fromColumn":"timestamp","toColumn":"timestamp"},{"fromColumn":"service","toColumn":"service"},{"fromColumn":"operation","toColumn":"operation"},{"fromColumn":"cost","toColumn":"cost"},{"fromColumn":"details","toColumn":"details"}]}},"name":"Save API Costs","type":"n8n-nodes-base.googleSheets","typeVersion":4,"position":[1400,300],"id":"a6d52519-6215-4a5e-9923-394fcc45f008"}],"connections":{"Webhook Trigger":{"main":[[{"node":"Get Carousel Queue","type":"main","index":0}]]},"Get Carousel Queue":{"main":[[{"node":"Filter Pending Carousels","type":"main","index":0}]]},"Filter Pending Carousels":{"main":[[{"node":"Get Content Data","type":"main","index":0}]]},"Get Content Data":{"main":[[{"node":"Generate Slides Content (Claude)","type":"main","index":0}]]},"Generate Slides Content (Claude)":{"main":[[{"node":"Parse Slides Content","type":"main","index":0}]]},"Parse Slides Content":{"main":[[{"node":"Generate Slide (Ideogram)","type":"main","index":0}]]},"Generate Slide (Ideogram)":{"main":[[{"node":"Parse Slide URL","type":"main","index":0}]]},"Parse Slide URL":{"main":[[{"node":"Aggregate All Slides","type":"main","index":0}]]},"Aggregate All Slides":{"main":[[{"node":"Prepare Final Data","type":"main","index":0},{"node":"Calculate API Costs","type":"main","index":0}]]},"Prepare Final Data":{"main":[[{"node":"Update Carousel_Queue","type":"main","index":0},{"node":"Update Content_Queue","type":"main","index":0}]]},"Update Carousel_Queue":{"main":[[{"node":"Trigger Preview (Orchestrator)","type":"main","index":0}]]},"Update Content_Queue":{"main":[[{"node":"Trigger Preview (Orchestrator)","type":"main","index":0}]]},"Calculate API Costs":{"main":[[{"node":"Save API Costs","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","availableInMCP":false},"staticData":null,"meta":null,"pinData":{},"versionId":"37556e38-7630-426e-a09d-e82e51ba05e6","versionCounter":5,"triggerCount":0,"shared":[{"updatedAt":"2025-12-24T14:20:47.429Z","createdAt":"2025-12-24T14:20:47.429Z","role":"workflow:owner","workflowId":"CgQnHIkKYfsNicA4","projectId":"RBPPu9AATeVK4CWS","project":{"updatedAt":"2025-09-12T08:23:30.032Z","createdAt":"2025-04-06T11:26:22.366Z","id":"RBPPu9AATeVK4CWS","name":"Ruslan 111 <105ford329@gmail.com>","type":"personal","icon":null,"description":null,"projectRelations":[{"updatedAt":"2025-04-06T11:26:22.366Z","createdAt":"2025-04-06T11:26:22.366Z","userId":"857820b0-f530-430a-b69c-96a0ec14e554","projectId":"RBPPu9AATeVK4CWS","user":{"updatedAt":"2026-01-15T07:57:19.897Z","createdAt":"2025-04-06T11:26:21.157Z","id":"857820b0-f530-430a-b69c-96a0ec14e554","email":"105ford329@gmail.com","firstName":"Ruslan","lastName":"111","personalizationAnswers":null,"settings":{"userActivated":true,"easyAIWorkflowOnboarded":true,"firstSuccessfulWorkflowId":"28ntO5KaE2bWGofZ","userActivatedAt":1746260344700,"npsSurvey":{"responded":true,"lastShownAt":1762343016289},"dismissedCallouts":{"preBuiltAgentsCalloutTelegram":true}},"disabled":false,"mfaEnabled":false,"lastActiveAt":"2026-01-14","isPending":false}}]}}],"tags":[]}